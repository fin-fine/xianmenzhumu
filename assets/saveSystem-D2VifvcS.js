const g=Object.freeze({tier:"炼气初期",currentExp:0,maxExp:500,spiritRoot:{type:"五灵根",elements:["金","木","水","火","土"],desc:"五行杂驳，灵气难聚，修行需要更长时间。",color:"#9E9E9E",multiplier:.5}}),C=()=>({tier:g.tier,currentExp:g.currentExp,maxExp:g.maxExp,spiritRoot:{...g.spiritRoot}}),b=(e={})=>{const t=C();let r=e.currentExp,o=e.maxExp;return(typeof r!="number"||isNaN(r)||!isFinite(r))&&(r=t.currentExp),(typeof o!="number"||isNaN(o)||!isFinite(o)||o<=0)&&(o=t.maxExp),{...e,tier:e.tier??t.tier,currentExp:r,maxExp:o,spiritRoot:e.spiritRoot?{...t.spiritRoot,...e.spiritRoot}:{...t.spiritRoot}}};[...g.spiritRoot.elements];g.tier;const A="xianmenzhumu_save_",F=65e3;let v=0,d=null,E=!1;const S=e=>({writeFileAsync:(a,s)=>new Promise((i,n)=>{if(!e)return n(new Error("file system not available"));if(typeof e.writeFileSync=="function"){try{e.writeFileSync(a,s,"utf8"),i()}catch(c){n(c)}return}if(typeof e.writeFile=="function"){try{e.writeFile.length>=3?e.writeFile(a,s,c=>c?n(c):i()):e.writeFile({filePath:a,data:s,encoding:"utf8",success:i,fail:c=>n(c)})}catch(c){n(c)}return}n(new Error("writeFile API not available"))}),readFileAsync:a=>new Promise((s,i)=>{if(!e)return i(new Error("file system not available"));if(typeof e.readFileSync=="function"){try{const n=e.readFileSync(a,"utf8");s(n)}catch(n){i(n)}return}if(typeof e.readFile=="function"){try{e.readFile.length>=2?e.readFile(a,(n,c)=>n?i(n):s(c)):e.readFile({filePath:a,encoding:"utf8",success:n=>s(n.data||n),fail:n=>i(n)})}catch(n){i(n)}return}i(new Error("readFile API not available"))}),unlinkAsync:a=>new Promise((s,i)=>{if(!e)return i(new Error("file system not available"));if(typeof e.unlinkSync=="function"){try{e.unlinkSync(a),s()}catch(n){i(n)}return}if(typeof e.unlink=="function"){try{e.unlink.length>=2?e.unlink(a,n=>n?i(n):s()):e.unlink({filePath:a,success:s,fail:n=>i(n)})}catch(n){i(n)}return}if(typeof e.remove=="function"){e.remove({filePath:a,success:s,fail:n=>i(n)});return}s()})}),D=()=>{if(E)return!0;try{return typeof tap>"u"||!tap.getCloudSaveManager?(console.warn("TapTap 云存档 API 不可用（可能不在 TapTap 小程序环境）"),!1):(d=tap.getCloudSaveManager(),E=!0,console.log("TapTap 云存档管理器初始化成功"),!0)}catch(e){return console.error("TapTap 云存档初始化失败:",e),!1}},x=()=>{const t=Date.now()-v;if(t<F){const r=Math.ceil((F-t)/1e3);return console.warn(`云存档上传冷却中，请等待 ${r} 秒后再试`),!1}return!0},N=()=>new Promise((e,t)=>{if(!E||!d){t(new Error("云存档未初始化"));return}d.getArchiveList({success:r=>{console.log("获取云存档列表成功:",r.saves.length,"个"),e(r.saves||[])},fail:({errMsg:r,errno:o})=>{console.error(`获取云存档列表失败: errno=${o}, errMsg=${r}`),t(new Error(`获取失败: ${r} (${o})`))}})}),T=async(e,t)=>new Promise(async(r,o)=>{var a,s,i,n,c;if(!E||!d){o(new Error("云存档未初始化"));return}if(!x()){o(new Error("上传冷却中，请稍后再试"));return}try{const l=JSON.stringify(t),u=new Blob([l]).size;if(u>10*1024*1024){o(new Error(`存档过大 (${(u/1024/1024).toFixed(2)}MB)，超过 10MB 限制`));return}const y=tap.getFileSystemManager(),h=S(y),p=`${tap.env.USER_DATA_PATH}/temp_save_slot${e}.json`;await h.writeFileAsync(p,l);const m={name:`${A}${e}`,summary:`存档位 ${e} - ${((a=t.player)==null?void 0:a.name)||"未知"} (${((s=t.player)==null?void 0:s.tierTitle)||"凡人"})`,extra:JSON.stringify({slot:e,playerName:(i=t.player)==null?void 0:i.name,cultivation:(n=t.player)==null?void 0:n.cultivation,timestamp:Date.now()}),playtime:Math.floor((((c=t.player)==null?void 0:c.age)||0)*365*24*3600)};d.createArchive({archiveMetaData:m,archiveFilePath:p,success:w=>{v=Date.now(),console.log("创建云存档成功:",w),h.unlinkAsync(p).catch(f=>console.warn("清理临时文件失败:",f)),r({uuid:w.uuid,fileId:w.fileId})},fail:({errMsg:w,errno:f})=>{console.error(`创建云存档失败: errno=${f}, errMsg=${w}`),h.unlinkAsync(p).catch(()=>{}),o(new Error(`创建失败: ${w} (${f})`))}})}catch(l){console.error("创建云存档时出错:",l),o(l)}}),_=(e,t,r)=>new Promise(async(o,a)=>{var s,i,n,c,l;if(!E||!d){a(new Error("云存档未初始化"));return}if(!x()){a(new Error("上传冷却中，请稍后再试"));return}try{const u=JSON.stringify(r),y=new Blob([u]).size;if(y>10*1024*1024){a(new Error(`存档过大 (${(y/1024/1024).toFixed(2)}MB)，超过 10MB 限制`));return}const h=tap.getFileSystemManager(),p=S(h),m=`${tap.env.USER_DATA_PATH}/temp_save_slot${t}.json`;await p.writeFileAsync(m,u);const w={name:`${A}${t}`,summary:`存档位 ${t} - ${((s=r.player)==null?void 0:s.name)||"未知"} (${((i=r.player)==null?void 0:i.tierTitle)||"凡人"})`,extra:JSON.stringify({slot:t,playerName:(n=r.player)==null?void 0:n.name,cultivation:(c=r.player)==null?void 0:c.cultivation,timestamp:Date.now()}),playtime:Math.floor((((l=r.player)==null?void 0:l.age)||0)*365*24*3600)};d.updateArchive({archiveUUID:e,archiveMetaData:w,archiveFilePath:m,success:f=>{v=Date.now(),console.log("更新云存档成功:",f),(async()=>{try{await p.unlinkAsync(m)}catch($){console.warn("清理临时文件失败:",$)}o({uuid:f.uuid,fileId:f.fileId})})()},fail:({errMsg:f,errno:$})=>{console.error(`更新云存档失败: errno=${$}, errMsg=${f}`),(async()=>{try{await p.unlinkAsync(m)}catch{}a(new Error(`更新失败: ${f} (${$})`))})()}})}catch(u){console.error("更新云存档时出错:",u),a(u)}}),U=(e,t,r)=>new Promise((o,a)=>{if(!E||!d){a(new Error("云存档未初始化"));return}const s=`${tap.env.USER_DATA_PATH}/cloud_save_slot${r}.json`;d.getArchiveData({archiveUUID:e,archiveFileId:t,targetFilePath:s,success:i=>{console.log("下载云存档成功:",i.filePath),(async()=>{try{const n=tap.getFileSystemManager(),c=S(n),l=await c.readFileAsync(i.filePath),u=JSON.parse(l);try{await c.unlinkAsync(i.filePath)}catch(y){console.warn("清理下载文件失败:",y)}o(u)}catch(n){console.error("解析云存档数据失败:",n),a(new Error("存档数据损坏"))}})()},fail:({errMsg:i,errno:n})=>{console.error(`下载云存档失败: errno=${n}, errMsg=${i}`),a(new Error(`下载失败: ${i} (${n})`))}})}),z=async(e,t)=>{try{const r=await N(),o=`${A}${e}`,a=r.find(s=>s.name===o);return a?(console.log(`云存档槽位 ${e} 已存在，执行更新操作`),{...await _(a.uuid,e,t),action:"update"}):(console.log(`云存档槽位 ${e} 不存在，执行创建操作`),{...await T(e,t),action:"create"})}catch(r){throw console.error("自动保存到云端失败:",r),r}},B=async(e,t)=>{try{const r=await N(),o=`${A}${e}`,a=r.find(i=>i.name===o);if(!a)return null;let s=0;try{s=JSON.parse(a.extra||"{}").timestamp||a.modifiedTime*1e3}catch{s=a.modifiedTime*1e3}return s>t?{uuid:a.uuid,fileId:a.fileId,cloudTimestamp:s,localTimestamp:t,summary:a.summary}:null}catch(r){return console.error("检查云存档时出错:",r),null}},L=["无法双修","赠礼失败","拒绝","岁月静好","虽然平静","但也不错","无事发生","今日无特"],M=["突破","境界","成就","死亡","去世","诞子","生子","入宗","晋升","修为","秘境","挑战","成为","获得","失去","背叛","复仇","刺杀","危险","重伤","警告","诅咒","秘闻","绯闻","丑闻","战斗","决斗","婚配","订婚","成婚","离异","流产","难产","礼物","赠予","结识","相识","遇见","私奔","寄养","逐出","驱逐","天机榜","拍卖","宝物","传承","秘籍"];function R(e){if(!e)return!1;for(const t of L)if(e.includes(t))return!1;for(const t of M)if(e.includes(t))return!0;return!0}function k(e,t=3572,r=1){return Array.isArray(e)?e.filter(o=>o.id&&o.id.startsWith("init-log")?!0:o.category==="个人大事"?R(o.message):!1):[]}function O(e,t=3572,r=1,o=50){if(!Array.isArray(e))return[];const s=`${t-1}-${String(r).padStart(2,"0")}`,i=[],n=[];return e.forEach(l=>{const u=l.content||"",y=l.year?`${l.year}-${String(l.month||1).padStart(2,"0")}`:"",h=l.isSecret||l.type==="MAJOR"||M.some(m=>u.includes(m)),p=!y||y>=s;h?i.push(l):p&&R(u)&&n.push(l)}),[...i,...n.slice(0,Math.max(0,o-i.length))]}function P(e,t=3572,r=1){return Array.isArray(e)?e.map(o=>o&&{...o,logs:O(o.logs,t,r,50)}):[]}function J(e){var o,a,s,i;if(!e||typeof e!="object")return e;const t=((a=(o=e.player)==null?void 0:o.time)==null?void 0:a.year)||3572,r=((i=(s=e.player)==null?void 0:s.time)==null?void 0:i.month)||1;return{...e,logs:k(e.logs,t,r),activeNpcs:P(e.activeNpcs,t,r),deadNpcs:P(e.deadNpcs,t,r)}}function Y(e,t){const r=(e.logs||[]).length,o=(t.logs||[]).length,a=(e.activeNpcs||[]).reduce((i,n)=>i+(n.logs||[]).length,0),s=(t.activeNpcs||[]).reduce((i,n)=>i+(n.logs||[]).length,0);return{mainLogsRemoved:r-o,npcLogsRemoved:a-s,mainLogsKept:o,npcLogsKept:s,totalRemoved:r-o+(a-s)}}export{b as a,B as b,J as c,U as d,z as e,N as f,C as g,Y as h,D as i};
