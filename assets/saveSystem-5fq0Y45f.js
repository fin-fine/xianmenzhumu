const h=Object.freeze({tier:"炼气初期",currentExp:0,maxExp:500,spiritRoot:{type:"五灵根",elements:["金","木","水","火","土"],desc:"五行杂驳，灵气难聚，修行需要更长时间。",color:"#9E9E9E",multiplier:.5}}),T=()=>({tier:h.tier,currentExp:h.currentExp,maxExp:h.maxExp,spiritRoot:{...h.spiritRoot}}),M=(e={})=>{const a=T();let r=e.currentExp,l=e.maxExp;return(typeof r!="number"||isNaN(r)||!isFinite(r))&&(r=a.currentExp),(typeof l!="number"||isNaN(l)||!isFinite(l)||l<=0)&&(l=a.maxExp),{...e,tier:e.tier??a.tier,currentExp:r,maxExp:l,spiritRoot:e.spiritRoot?{...a.spiritRoot,...e.spiritRoot}:{...a.spiritRoot}}};[...h.spiritRoot.elements];h.tier;const A="xianmenzhumu_save_",S=65e3;let F=0,p=null,E=!1;const g=e=>({writeFileAsync:(t,o)=>new Promise((i,n)=>{if(!e)return n(new Error("file system not available"));if(typeof e.writeFileSync=="function"){try{e.writeFileSync(t,o,"utf8"),i()}catch(s){n(s)}return}if(typeof e.writeFile=="function"){try{e.writeFile.length>=3?e.writeFile(t,o,s=>s?n(s):i()):e.writeFile({filePath:t,data:o,encoding:"utf8",success:i,fail:s=>n(s)})}catch(s){n(s)}return}n(new Error("writeFile API not available"))}),readFileAsync:t=>new Promise((o,i)=>{if(!e)return i(new Error("file system not available"));if(typeof e.readFileSync=="function"){try{const n=e.readFileSync(t,"utf8");o(n)}catch(n){i(n)}return}if(typeof e.readFile=="function"){try{e.readFile.length>=2?e.readFile(t,(n,s)=>n?i(n):o(s)):e.readFile({filePath:t,encoding:"utf8",success:n=>o(n.data||n),fail:n=>i(n)})}catch(n){i(n)}return}i(new Error("readFile API not available"))}),unlinkAsync:t=>new Promise((o,i)=>{if(!e)return i(new Error("file system not available"));if(typeof e.unlinkSync=="function"){try{e.unlinkSync(t),o()}catch(n){i(n)}return}if(typeof e.unlink=="function"){try{e.unlink.length>=2?e.unlink(t,n=>n?i(n):o()):e.unlink({filePath:t,success:o,fail:n=>i(n)})}catch(n){i(n)}return}if(typeof e.remove=="function"){e.remove({filePath:t,success:o,fail:n=>i(n)});return}o()})}),C=()=>{if(E)return!0;try{return typeof tap>"u"||!tap.getCloudSaveManager?(console.warn("TapTap 云存档 API 不可用（可能不在 TapTap 小程序环境）"),!1):(p=tap.getCloudSaveManager(),E=!0,console.log("TapTap 云存档管理器初始化成功"),!0)}catch(e){return console.error("TapTap 云存档初始化失败:",e),!1}},P=()=>{const a=Date.now()-F;if(a<S){const r=Math.ceil((S-a)/1e3);return console.warn(`云存档上传冷却中，请等待 ${r} 秒后再试`),!1}return!0},x=()=>new Promise((e,a)=>{if(!E||!p){a(new Error("云存档未初始化"));return}p.getArchiveList({success:r=>{console.log("获取云存档列表成功:",r.saves.length,"个"),e(r.saves||[])},fail:({errMsg:r,errno:l})=>{console.error(`获取云存档列表失败: errno=${l}, errMsg=${r}`),a(new Error(`获取失败: ${r} (${l})`))}})}),_=async(e,a)=>new Promise(async(r,l)=>{var t,o,i,n,s;if(!E||!p){l(new Error("云存档未初始化"));return}if(!P()){l(new Error("上传冷却中，请稍后再试"));return}try{const u=JSON.stringify(a),y=new Blob([u]).size;if(y>10*1024*1024){l(new Error(`存档过大 (${(y/1024/1024).toFixed(2)}MB)，超过 10MB 限制`));return}const w=tap.getFileSystemManager(),$=g(w),f=`${tap.env.USER_DATA_PATH}/temp_save_slot${e}.json`;await $.writeFileAsync(f,u);const m={name:`${A}${e}`,summary:`存档位 ${e} - ${((t=a.player)==null?void 0:t.name)||"未知"} (${((o=a.player)==null?void 0:o.tierTitle)||"凡人"})`,extra:JSON.stringify({slot:e,playerName:(i=a.player)==null?void 0:i.name,cultivation:(n=a.player)==null?void 0:n.cultivation,timestamp:Date.now()}),playtime:Math.floor((((s=a.player)==null?void 0:s.age)||0)*365*24*3600)};p.createArchive({archiveMetaData:m,archiveFilePath:f,success:d=>{F=Date.now(),console.log("创建云存档成功:",d),$.unlinkAsync(f).catch(c=>console.warn("清理临时文件失败:",c)),r({uuid:d.uuid,fileId:d.fileId})},fail:({errMsg:d,errno:c})=>{console.error(`创建云存档失败: errno=${c}, errMsg=${d}`),$.unlinkAsync(f).catch(()=>{}),l(new Error(`创建失败: ${d} (${c})`))}})}catch(u){console.error("创建云存档时出错:",u),l(u)}}),N=(e,a,r)=>new Promise(async(l,t)=>{var o,i,n,s,u;if(!E||!p){t(new Error("云存档未初始化"));return}if(!P()){t(new Error("上传冷却中，请稍后再试"));return}try{const y=JSON.stringify(r),w=new Blob([y]).size;if(w>10*1024*1024){t(new Error(`存档过大 (${(w/1024/1024).toFixed(2)}MB)，超过 10MB 限制`));return}const $=tap.getFileSystemManager(),f=g($),m=`${tap.env.USER_DATA_PATH}/temp_save_slot${a}.json`;await f.writeFileAsync(m,y);const d={name:`${A}${a}`,summary:`存档位 ${a} - ${((o=r.player)==null?void 0:o.name)||"未知"} (${((i=r.player)==null?void 0:i.tierTitle)||"凡人"})`,extra:JSON.stringify({slot:a,playerName:(n=r.player)==null?void 0:n.name,cultivation:(s=r.player)==null?void 0:s.cultivation,timestamp:Date.now()}),playtime:Math.floor((((u=r.player)==null?void 0:u.age)||0)*365*24*3600)};p.updateArchive({archiveUUID:e,archiveMetaData:d,archiveFilePath:m,success:c=>{F=Date.now(),console.log("更新云存档成功:",c),(async()=>{try{await f.unlinkAsync(m)}catch(v){console.warn("清理临时文件失败:",v)}l({uuid:c.uuid,fileId:c.fileId})})()},fail:({errMsg:c,errno:v})=>{console.error(`更新云存档失败: errno=${v}, errMsg=${c}`),(async()=>{try{await f.unlinkAsync(m)}catch{}t(new Error(`更新失败: ${c} (${v})`))})()}})}catch(y){console.error("更新云存档时出错:",y),t(y)}}),k=(e,a,r)=>new Promise((l,t)=>{if(!E||!p){t(new Error("云存档未初始化"));return}const o=`${tap.env.USER_DATA_PATH}/cloud_save_slot${r}.json`;p.getArchiveData({archiveUUID:e,archiveFileId:a,targetFilePath:o,success:i=>{console.log("下载云存档成功:",i.filePath),(async()=>{try{const n=tap.getFileSystemManager(),s=g(n),u=await s.readFileAsync(i.filePath),y=JSON.parse(u);try{await s.unlinkAsync(i.filePath)}catch(w){console.warn("清理下载文件失败:",w)}l(y)}catch(n){console.error("解析云存档数据失败:",n),t(new Error("存档数据损坏"))}})()},fail:({errMsg:i,errno:n})=>{console.error(`下载云存档失败: errno=${n}, errMsg=${i}`),t(new Error(`下载失败: ${i} (${n})`))}})}),R=async(e,a)=>{try{const r=await x(),l=`${A}${e}`,t=r.find(o=>o.name===l);return t?(console.log(`云存档槽位 ${e} 已存在，执行更新操作`),{...await N(t.uuid,e,a),action:"update"}):(console.log(`云存档槽位 ${e} 不存在，执行创建操作`),{...await _(e,a),action:"create"})}catch(r){throw console.error("自动保存到云端失败:",r),r}},O=async(e,a)=>{try{const r=await x(),l=`${A}${e}`,t=r.find(i=>i.name===l);if(!t)return null;let o=0;try{o=JSON.parse(t.extra||"{}").timestamp||t.modifiedTime*1e3}catch{o=t.modifiedTime*1e3}return o>a?{uuid:t.uuid,fileId:t.fileId,cloudTimestamp:o,localTimestamp:a,summary:t.summary}:null}catch(r){return console.error("检查云存档时出错:",r),null}};export{M as a,R as b,O as c,k as d,x as e,T as g,C as i};
